@model IEnumerable<ClinicManagementSystem.ViewModel.AppointmentViewModel>
@{
    Layout = "~/Views/Shared/ReceptionistNav.cshtml";
}

<div class="container-fluid px-2 px-md-3">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        <h2 class="mb-2 mb-md-0 text-center text-md-start">Appointments</h2>
    </div>

    <form method="get" asp-action="ViewAppointments">
        <div class="row g-2 mb-3">

            <div class="col-12 col-md-4 col-lg-3">
                <label class="form-label">Doctor</label>
                <select name="doctorId" class="form-select">
                    <option value="">All</option>
                    @foreach (var doc in ViewBag.Doctors)
                    {
                        <option value="@doc.DoctorId"
                                selected="@(Context.Request.Query["doctorId"] == doc.DoctorId.ToString())">
                            @doc.DoctorName
                        </option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-4 col-lg-3">
                <label class="form-label">Date</label>
                <input type="date"
                       name="appointmentDate"
                       value="@Context.Request.Query["appointmentDate"]"
                       class="form-control" />
            </div>

            <div class="col-12 col-md-4 col-lg-3 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary w-100">
                    Search
                </button>

                <a asp-action="ViewAppointments"
                   class="btn btn-secondary w-100">
                    Reset
                </a>
            </div>

        </div>
    </form>



    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle text-center">
            <thead class="table-dark">
                <tr>
                    <th>Token</th>
                    <th>Patient</th>
                    <th class="d-none d-md-table-cell">Doctor</th>
                    <th class="d-none d-lg-table-cell">Specialization</th>
                    <th>Date</th>
                    <th class="d-none d-md-table-cell">Time</th>
                    <th>Status</th>
                    <th>Bill</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.Token</td>
                        <td class="fw-semibold">@item.PatientName</td>

                        <td class="d-none d-md-table-cell">
                            @item.DoctorName
                        </td>

                        <td class="d-none d-lg-table-cell">
                            @item.SpecializationName
                        </td>

                        <td>
                            @item.AppointmentDate.ToShortDateString()
                        </td>

                        <td class="d-none d-md-table-cell">
                            @item.AppointmentDate.ToShortTimeString()
                            -
                            @item.AppointmentEndTime.ToShortTimeString()
                        </td>

                        <td>
                            @if (item.AppointmentStatus == "Completed")
                            {
                                <span class="badge bg-success">Completed</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark">Pending</span>
                            }
                        </td>

                        <td>
                            <div class="d-grid d-md-flex gap-1 justify-content-md-center">
                                @if (item.IsBillGenerated)
                                {
                                    <button class="btn btn-primary btn-sm w-100 w-md-auto"
                                            onclick="viewBill(@item.PatientBillId)">
                                        View
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-success btn-sm w-100 w-md-auto"
                                            onclick="generateBill(@item.AppointmentId)">
                                        Generate
                                    </button>
                                }
                            </div>
                        </td>

                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@Html.AntiForgeryToken()

<!-- BILL MODAL -->
<div class="modal fade" id="billModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="billContent">

            <div class="modal-header">
                <h5>Patient Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="billPrintArea">

                <div class="text-center">
                    <h4>Vettumani Hospital</h4>
                    <small>Patient Bill Receipt</small>
                </div>

                <hr />

                <p><b>Bill No:</b> <span id="billId"></span></p>
                <p><b>Token:</b> <span id="token"></span></p>
                <p><b>Patient:</b> <span id="patientName"></span></p>
                <p><b>Doctor:</b> <span id="doctorName"></span></p>
                <p><b>Appointment Date:</b> <span id="appointmentDate"></span></p>

                <hr />

                <h5 class="text-end">Amount: ₹ <span id="billAmount"></span></h5>
                <div class="text-end">
                    <span class="badge bg-success" id="billStatus"></span>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="printBill()">Print PDF</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

@section Scripts {

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>

        function getToken() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        function generateBill(appointmentId)
        {
            $.ajax({
                url: '/Receptionist/GenerateBill',
                type: 'POST',
                data: {
                    appointmentId: appointmentId,
                    __RequestVerificationToken: getToken()
                },
                success: function (data)
                {
                    if (!data || (!data.patientBillId && !data.isSuccess))
                    {
                        alert(data.statusMessage || "Bill generation failed");
                        return;
                    }

                    fillBillModal(data);
                }
            });
        }

        function viewBill(billId)
        {
            $.get('/Receptionist/GetBillById', { id: billId }, function (data)
            {
                if (!data)
                {
                    alert("Bill not found");
                    return;
                }

                fillBillModal(data);
            });
        }

        function fillBillModal(data)
        {
            $("#billId").text(data.patientBillId);
            $("#token").text(data.token);
            $("#patientName").text(data.patientName);
            $("#doctorName").text(data.doctorName);
            $("#appointmentDate").text(
                new Date(data.appointmentDate).toLocaleString()
            );
            $("#billAmount").text(data.billAmount);
            $("#billStatus").text(data.billStatus);

            new bootstrap.Modal(document.getElementById('billModal')).show();
        }

        function printBill() {

            var element = document.getElementById("billPrintArea");

            html2pdf()
                .from(element)
                .save("Patient_Bill.pdf");
        }


    </script>
}
