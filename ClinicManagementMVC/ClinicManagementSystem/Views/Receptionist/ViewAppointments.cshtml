@model IEnumerable<ClinicManagementSystem.ViewModel.AppointmentViewModel>
@{
    Layout = "~/Views/Shared/ReceptionistNav.cshtml";
}

<h2>Appointments</h2>

<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>Token</th>
            <th>Patient</th>
            <th>Doctor</th>
            <th>Specialization</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Bill</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.Token</td>
                <td>@item.PatientName</td>
                <td>@item.DoctorName</td>
                <td>@item.SpecializationName</td>
                <td>@item.AppointmentDate.ToShortDateString()</td>
                <td>
                    @item.AppointmentDate.ToShortTimeString()
                    -
                    @item.AppointmentEndTime.ToShortTimeString()
                </td>

                <td>
                    @if (item.AppointmentStatus == "Completed")
                    {
                        <span class="badge bg-success">Completed</span>
                    }
                    else
                    {
                        <span class="badge bg-warning text-dark">Pending</span>
                    }
                </td>

                <td>
                    @* BILL ALREADY GENERATED *@
                    @if (item.IsBillGenerated)@*Error*@
                    {
                        <button class="btn btn-primary btn-sm"
                                onclick="viewBill(@item.PatientBillId)"> @*Error*@
                            View Bill
                        </button>
                    }
                    @* GENERATE BILL *@
                    else if (item.AppointmentStatus == "Completed")
                    {
                        <button class="btn btn-success btn-sm"
                                onclick="generateBill(@item.AppointmentId)">
                            Generate Bill
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-secondary btn-sm" disabled>
                            Generate Bill
                        </button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@Html.AntiForgeryToken()

<!-- BILL MODAL -->
<div class="modal fade" id="billModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="billContent">

            <div class="modal-header">
                <h5>Patient Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="text-center">
                    <h4>Clinic Management System</h4>
                    <small>Patient Bill Receipt</small>
                </div>

                <hr />

                <p><b>Bill No:</b> <span id="billId"></span></p>
                <p><b>Token:</b> <span id="token"></span></p>
                <p><b>Patient:</b> <span id="patientName"></span></p>
                <p><b>Doctor:</b> <span id="doctorName"></span></p>
                <p><b>Appointment Date:</b> <span id="appointmentDate"></span></p>

                <hr />

                <h5 class="text-end">Amount: ₹ <span id="billAmount"></span></h5>
                <div class="text-end">
                    <span class="badge bg-success" id="billStatus"></span>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="printBill()">Print PDF</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

@section Scripts {

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>

        function getToken() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        function generateBill(appointmentId)
        {
            $.ajax({
                url: '/Receptionist/GenerateBill',
                type: 'POST',
                data: {
                    appointmentId: appointmentId,
                    __RequestVerificationToken: getToken()
                },
                success: function (data)
                {
                    if (!data || (!data.patientBillId && !data.isSuccess))
                    {
                        alert(data.statusMessage || "Bill generation failed");
                        return;
                    }

                    fillBillModal(data);
                }
            });
        }

        function viewBill(billId)
        {
            $.get('/Receptionist/GetBillById', { id: billId }, function (data)
            {
                if (!data)
                {
                    alert("Bill not found");
                    return;
                }

                fillBillModal(data);
            });
        }

        function fillBillModal(data)
        {
            $("#billId").text(data.patientBillId);
            $("#token").text(data.token);
            $("#patientName").text(data.patientName);
            $("#doctorName").text(data.doctorName);
            $("#appointmentDate").text(
                new Date(data.appointmentDate).toLocaleString()
            );
            $("#billAmount").text(data.billAmount);
            $("#billStatus").text(data.billStatus);

            new bootstrap.Modal(document.getElementById('billModal')).show();
        }

        function printBill()
        {
            var element = document.getElementById("billContent");

            html2pdf()
                .from(element)
                .save("Patient_Bill.pdf");
        }

    </script>
}
