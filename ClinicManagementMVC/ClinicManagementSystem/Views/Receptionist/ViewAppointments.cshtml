@model IEnumerable<ClinicManagementSystem.ViewModel.AppointmentViewModel>
@{
    Layout = "~/Views/Shared/ReceptionistNav.cshtml";
}

<div class="container-fluid px-2 px-md-3">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        <h2 class="mb-2 mb-md-0 text-center text-md-start">Appointments</h2>
    </div>

    <form method="get" asp-action="ViewAppointments">
        <div class="row g-2 mb-3">

            <div class="col-12 col-md-4 col-lg-3">
                <label class="form-label">Doctor</label>
                <select name="doctorId" class="form-select">
                    <option value="">All</option>
                    @foreach (var doc in ViewBag.Doctors)
                    {
                        <option value="@doc.DoctorId"
                                selected="@(Context.Request.Query["doctorId"] == doc.DoctorId.ToString())">
                            @doc.DoctorName
                        </option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-4 col-lg-3">
                <label class="form-label">Date</label>
                <input type="date"
                       name="appointmentDate"
                       value="@Context.Request.Query["appointmentDate"]"
                       class="form-control" />
            </div>

            <div class="col-12 col-md-4 col-lg-3 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary w-100">
                    Search
                </button>

                <a asp-action="ViewAppointments"
                   class="btn btn-secondary w-100">
                    Reset
                </a>
            </div>

        </div>
    </form>



    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle text-center">
            <thead class="table-dark">
                <tr>
                    <th>Token</th>
                    <th>Patient</th>
                    <th class="d-none d-md-table-cell">Doctor</th>
                    <th class="d-none d-lg-table-cell">Specialization</th>
                    <th>Date</th>
                    <th class="d-none d-md-table-cell">Time</th>
                    <th>Status</th>
                    <th>Bill</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.Token</td>
                        <td class="fw-semibold">@item.PatientName</td>

                        <td class="d-none d-md-table-cell">
                            @item.DoctorName
                        </td>

                        <td class="d-none d-lg-table-cell">
                            @item.SpecializationName
                        </td>

                        <td>
                            @item.AppointmentDate.ToShortDateString()
                        </td>

                        <td class="d-none d-md-table-cell">
                            @item.AppointmentDate.ToShortTimeString()
                            -
                            @item.AppointmentEndTime.ToShortTimeString()
                        </td>

                        <td>
                            @if (item.AppointmentStatus == "Completed")
                            {
                                <span class="badge bg-success">Completed</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark">Pending</span>
                            }
                        </td>

                        <td>
                            <div class="d-grid d-md-flex gap-1 justify-content-md-center">
                                @if (item.IsBillGenerated)
                                {
                                    <button class="btn btn-primary btn-sm w-100 w-md-auto"
                                            onclick="viewBill(@item.PatientBillId)">
                                        View
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-success btn-sm w-100 w-md-auto"
                                            onclick="generateBill(@item.AppointmentId)">
                                        Generate
                                    </button>
                                }
                            </div>
                        </td>

                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@Html.AntiForgeryToken()

<!-- BILL MODAL -->
<div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog modal-lg  modal-fullscreen-sm-down">
        <div class="modal-content">

            <div class="modal-header no-print">
                <h5>Patient Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- ⭐ PRINT AREA -->
            <div class="modal-body bg-white p-4" id="printArea">

                <div class="text-center mb-4">
                    <h2 class="text-primary">Medicare</h2>
                    <p class="mb-0">Address Kazhakuttam, Thiruvananthapuram, Kerala</p>
                    <p class="mb-0">Phone: +91-8983457123 | Email: medicare@gmail.com</p>
                    <hr />
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <p><strong>Patient:</strong> <span id="patientName"></span></p>
                        <p><strong>Doctor:</strong> <span id="doctorName"></span></p>
                        <p><strong>Token:</strong> <span id="token"></span></p>
                    </div>

                    <div class="col-6 text-end">
                        <p><strong>Bill No:</strong> <span id="billId"></span></p>
                        <p><strong>Date:</strong> <span id="appointmentDate"></span></p>
                        <p>
                            <strong>Status:</strong>
                            <span class="badge bg-success" id="billStatus"></span>
                        </p>
                    </div>
                </div>

                <hr />

                <div class="text-end">
                    <h4>Total Amount : ₹ <span id="billAmount"></span></h4>
                </div>

                <div class="mt-5 text-end">
                    <p>Generated By: Receptionist</p>
                </div>

            </div>

            <div class="modal-footer no-print">
                <button class="btn btn-dark" onclick="printBill()">Print Bill</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>



@section Scripts {
    <script>

        function getToken() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        function generateBill(appointmentId)
        {
            $.ajax({
                url: '/Receptionist/GenerateBill',
                type: 'POST',
                data: {
                    appointmentId: appointmentId,
                    __RequestVerificationToken: getToken()
                },
                success: function (data)
                {
                    if (!data || (!data.patientBillId && !data.isSuccess))
                    {
                        alert(data.statusMessage || "Bill generation failed");
                        return;
                    }

                    fillBillModal(data);
                }
            });
        }

        function viewBill(billId)
        {
            $.get('/Receptionist/GetBillById', { id: billId }, function (data)
            {
                if (!data)
                {
                    alert("Bill not found");
                    return;
                }

                fillBillModal(data);
            });
        }

        function fillBillModal(data)
        {
            $("#billId").text(data.patientBillId);
            $("#token").text(data.token);
            $("#patientName").text(data.patientName);
            $("#doctorName").text(data.doctorName);
            $("#appointmentDate").text(
                new Date(data.appointmentDate).toLocaleDateString('en-GB')
            );
            $("#billAmount").text(data.billAmount);
            $("#billStatus").text(data.billStatus);


            new bootstrap.Modal(document.getElementById('billModal')).show();
        }

        function printBill() {
            setTimeout(() => {
                window.print();
            }, 500);
        }


    </script>
}


<style>
    @@media print {

        body * {
            visibility: hidden !important;
        }

        #printArea, #printArea * {
            visibility: visible !important;
        }

        #printArea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 20px;
        }

        .no-print {
            display: none !important;
        }

        @@page {
            margin: 10mm;
        }
    }
</style>