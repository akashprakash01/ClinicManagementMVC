@model IEnumerable<ClinicManagementSystem.Models.Patient>
@{
    Layout = "~/Views/Shared/ReceptionistNav.cshtml";
}

<div class="container-fluid px-2 px-md-3">

    <!-- ================= HEADER ================= -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
        <h2 class="mb-lg-3 text-center text-md-start text-nowrap">
            Patients List
        </h2>
        <button class="btn btn-primary btn-sm px-3 py-1 w-md-auto fs-6"
                data-bs-toggle="modal"
                data-bs-target="#addPatientModal">
            <i class="fas fa-user-plus"></i> Add Patient
        </button>
    </div>

    <!-- ================= SEARCH ================= -->
    <div class="row mb-3">
        <div class="col-12 col-md-6 col-lg-4">
            <div class="input-group">
                <input type="text"
                       id="searchBox"
                       class="form-control"
                       placeholder="Search by ID / Name / Contact" />
                <button class="btn btn-outline-secondary"
                        type="button"
                        id="clearSearch">
                    Clear
                </button>
            </div>
        </div>
    </div>

    <!-- ================= TABLE ================= -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle text-center">
            <thead class="table-light">
                <tr>
                    <th class="text-nowrap">MMR No</th>
                    <th>Name</th>
                    <th class="d-none d-md-table-cell">DOB</th>
                    <th class="d-none d-md-table-cell">Gender</th>
                    <th>Contact</th>
                    <th class="d-none d-lg-table-cell">Address</th>
                    <th>Appointment</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody id="patientTable">
                @foreach (var patient in Model)
                {
                    <tr>
                        <td>@patient.PatientId</td>
                        <td class="fw-semibold">@patient.Name</td>
                        <td class="d-none d-md-table-cell">
                            @patient.DOB.ToShortDateString()
                        </td>
                        <td class="d-none d-md-table-cell">
                            @patient.Gender
                        </td>
                        <td>@patient.Contact</td>
                        <td class="d-none d-lg-table-cell">
                            @patient.Address
                        </td>

                        <!-- Appointment Buttons -->
                        <td>
                            <div class="d-grid d-md-flex gap-1 justify-content-md-center">
                                <button class="btn btn-success btn-sm w-100 w-md-auto"
                                        onclick="openAppointmentModal(@patient.PatientId,0)">
                                    Today
                                </button>

                                <button class="btn btn-warning btn-sm w-100 w-md-auto"
                                        onclick="openAppointmentModal(@patient.PatientId,1)">
                                    Tomorrow
                                </button>
                            </div>
                        </td>

                        <!-- Edit Button -->
                        <td>
                            <button class="btn btn-primary btn-sm w-100 w-md-auto"
                                    onclick="openEditModal(@patient.PatientId)">
                                Edit
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

</div>

@*========================= Add Patient modal form ====================*@

<div class="modal fade" id="addPatientModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5>Add Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="addPatientForm" novalidate>
                    @Html.AntiForgeryToken()

                    <div class="mb-2">
                        <input name="Name" id="addName"
                               class="form-control"
                               placeholder="Name"
                               required
                               minlength="3"
                               maxlength="50" />
                        <span class="text-danger validation-message" data-valmsg-for="Name"></span>
                    </div>

                    <div class="mb-2">
                        <input name="DOB" id="addDOB"
                               type="date"
                               class="form-control"
                               required />
                        <span class="text-danger validation-message" data-valmsg-for="DOB"></span>
                    </div>

                    <div class="mb-2">
                        <select name="Gender" id="addGender" class="form-control" required>
                            <option value="">Select Gender</option>
                            <option>Male</option>
                            <option>Female</option>
                        </select>
                        <span class="text-danger validation-message" data-valmsg-for="Gender"></span>
                    </div>

                    <div class="mb-2">
                        <input name="Contact" id="addContact"
                               class="form-control"
                               placeholder="Contact"
                               required
                               pattern="^[6-9][0-9]{9}$" />
                        <span class="text-danger validation-message" data-valmsg-for="Contact"></span>
                    </div>

                    <div class="mb-2">
                        <textarea name="Address"
                                  id="addAddress"
                                  class="form-control"
                                  placeholder="Address"
                                  maxlength="250"></textarea>
                    </div>

                    <button class="btn btn-success w-100">Save</button>
                </form>

            </div>

        </div>
    </div>
</div>

@*========================= Appointment modal form ====================*@

<div class="modal fade" id="appointmentModal">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5>Book Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="patientId" />

                <label>Select Doctor</label>
                <select id="doctorSelect" class="form-control"></select>

                <br />

                <label>Select Slot</label>
                <select id="slotSelect" class="form-control" size="10" disabled></select>

            </div>

            <div class="modal-footer">

                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Cancel
                </button>

                <button class="btn btn-primary"
                        onclick="bookAppointment()">
                    Book
                </button>

            </div>


        </div>
    </div>
</div>

@*========================= Edit Patient modal form ====================*@
<div class="modal fade" id="editPatientModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5>Edit Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <form id="editPatientForm" novalidate>
                    @Html.AntiForgeryToken()

                    <input type="hidden" id="editPatientId" name="PatientId" />

                    <div class="mb-2">
                        <label>Name</label>
                        <input id="editName" name="Name" class="form-control" />
                        <span class="text-danger validation-message" data-valmsg-for="Name"></span>
                    </div>

                    <div class="mb-2">
                        <label>DOB</label>
                        <input type="date" id="editDOB" name="DOB" class="form-control" />
                        <span class="text-danger validation-message" data-valmsg-for="DOB"></span>
                    </div>

                    <div class="mb-2">
                        <label>Gender</label>
                        <select id="editGender" name="Gender" class="form-control">
                            <option value="">Select</option>
                            <option>Male</option>
                            <option>Female</option>
                        </select>
                        <span class="text-danger validation-message" data-valmsg-for="Gender"></span>
                    </div>

                    <div class="mb-2">
                        <label>Contact</label>
                        <input id="editContact" name="Contact" class="form-control" />
                        <span class="text-danger validation-message" data-valmsg-for="Contact"></span>
                    </div>

                    <div class="mb-2">
                        <label>Address</label>
                        <textarea id="editAddress" name="Address" class="form-control"></textarea>
                    </div>

                    <button class="btn btn-success w-100">Update</button>

                </form>

            </div>

        </div>
    </div>
</div>


@section Scripts {
<script>

    $(document).ready(function () {

        // ---------------- ADD PATIENT SUBMIT ----------------
        $("#addPatientForm").submit(function (e) {

            e.preventDefault();

            if (!validatePatientForm("add"))
                return;

            $.ajax({
                url: '/Receptionist/CreatePatient',
                type: 'POST',
                data: $(this).serialize(),
                headers: {
                    'RequestVerificationToken':
                        $('input[name="__RequestVerificationToken"]').val()
                },

                success: function (response) {

                    if (response.success) {

                        alert(response.message);

                        bootstrap.Modal.getInstance(
                            document.getElementById('addPatientModal')).hide();

                        location.reload();
                    }
                    else if (response.errors) {

                        $("#addPatientForm .validation-message").text("");

                        $.each(response.errors, function (key, messages) {

                            $("#addPatientForm")
                                .find(`[data-valmsg-for='${key}']`)
                                .text(messages[0]);

                        });
                    }
                    else {
                        alert(response.message);
                    }
                }
            });

        });

        // ---------------- EDIT PATIENT SUBMIT ----------------
        $("#editPatientForm").submit(function (e) {

            e.preventDefault();

            if (!validatePatientForm("edit")) return;

            $.ajax({
                url: '/Receptionist/Edit',
                type: 'POST',
                data: $(this).serialize(),
                headers: {
                    'RequestVerificationToken':
                        $('#editPatientForm input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {

                    bootstrap.Modal.getInstance(
                        document.getElementById('editPatientModal')
                    ).hide();

                    location.reload();
                }
            });

        });

        // ---------------- SEARCH ----------------
        $("#clearSearch").hide();

        $("#searchBox").on("keyup", function () {

            let value = $(this).val().toLowerCase();

            $("#clearSearch").toggle(value.length > 0);

            $("#patientTable tr").each(function () {

                let id = $(this).find("td:eq(0)").text().toLowerCase();
                let name = $(this).find("td:eq(1)").text().toLowerCase();
                let contact = $(this).find("td:eq(4)").text().toLowerCase();

                $(this).toggle(
                    id.includes(value) ||
                    name.includes(value) ||
                    contact.includes(value)
                );
            });
        });

        $("#clearSearch").on("click", function () {
            $("#searchBox").val("");
            $("#patientTable tr").show();
            $(this).hide();
        });

        // ---------------- REAL-TIME VALIDATION ----------------
        $("#addName, #addDOB, #addGender, #addContact").on("input change", function () {
            validatePatientForm("add");
        });

        $("#editName, #editDOB, #editGender, #editContact").on("input change", function () {
            validatePatientForm("edit");
        });

    });


    // ---------------- APPOINTMENT MODAL ----------------
    let selectedDate = null;

    function openAppointmentModal(patientId, dayOffset) {

        $("#patientId").val(patientId);

        selectedDate = new Date();
        selectedDate.setDate(selectedDate.getDate() + dayOffset);

        $.get('/Receptionist/GetAvailableDoctors',
            { dayOffset: dayOffset },
            function (data) {

                $("#doctorSelect").empty();
                $("#slotSelect").empty().prop("disabled", true);

                data.forEach(doc => {
                    $("#doctorSelect").append(
                        `<option value="${doc.doctorId}">
                            ${doc.doctorName} (${doc.specializationName})
                        </option>`
                    );
                });

                $("#doctorSelect").trigger("change");
            });

        new bootstrap.Modal(document.getElementById('appointmentModal')).show();
    }


    // LOAD SLOTS
    $("#doctorSelect").on("change", function () {

        let doctorId = $(this).val();

        let formattedDate = selectedDate.toISOString().split('T')[0];

        $.get('/Receptionist/GetSlots',
            {
                doctorId: doctorId,
                selectedDate: formattedDate
            },
            function (slots) {

                $("#slotSelect").empty();

                if (slots.length === 0) {
                    $("#slotSelect").append(`<option>No slots available</option>`);
                    return;
                }

                slots.forEach(slot => {

                    $("#slotSelect").append(
                        `<option
                            data-start="${slot.startTime}"
                            data-end="${slot.endTime}">
                            ${slot.text}
                        </option>`
                    );

                });

                $("#slotSelect").prop("disabled", false);
            });
    });


    // BOOK APPOINTMENT
    function bookAppointment() {

        let selected = $("#slotSelect option:selected");

        let data = {
            patientId: $("#patientId").val(),
            doctorId: $("#doctorSelect").val(),
            start: selected.data("start"),
            end: selected.data("end")
        };

        $.post('/Receptionist/BookAppointment', data, function (res) {

            if (res.success) {
                alert(res.message);
                location.reload();
            } else {
                alert(res.message);
            }

        });
    }


    // ---------------- VALIDATION FUNCTION ----------------
    function validatePatientForm(prefix) {

        let isValid = true;
        let form = $(`#${prefix}PatientForm`);

        let name = $(`#${prefix}Name`).val().trim();
        let dob = $(`#${prefix}DOB`).val();
        let gender = $(`#${prefix}Gender`).val();
        let contact = $(`#${prefix}Contact`).val();

        form.find(".validation-message").text("");

        if (name.length < 3) {
            form.find("[data-valmsg-for='Name']").text("Name must be at least 3 characters");
            isValid = false;
        }

        if (!dob) {
            form.find("[data-valmsg-for='DOB']").text("DOB is required");
            isValid = false;
        }
        else {
            let birthDate = new Date(dob);
            let today = new Date();
            today.setHours(0, 0, 0, 0);

            if (birthDate >= today) {
                form.find("[data-valmsg-for='DOB']").text("DOB must be in the past");
                isValid = false;
            }
        }

        if (!gender) {
            form.find("[data-valmsg-for='Gender']").text("Please select gender");
            isValid = false;
        }

        let contactRegex = /^[6-9][0-9]{9}$/;

        if (!contactRegex.test(contact)) {
            form.find("[data-valmsg-for='Contact']").text("Enter valid 10 digit mobile number");
            isValid = false;
        }

        return isValid;
    }


    function clearValidation(prefix) {
        $(`#${prefix}PatientForm`).find(".validation-message").text("");
    }


    function openEditModal(id) {
        clearValidation("edit");

        $.get('/Receptionist/Edit/' + id, function (data) {

            $("#editPatientId").val(data.patientId);
            $("#editName").val(data.name);
            $("#editDOB").val(data.dob.split('T')[0]);
            $("#editGender").val(data.gender);
            $("#editContact").val(data.contact);
            $("#editAddress").val(data.address);

            new bootstrap.Modal(document.getElementById('editPatientModal')).show();
        });

    }

</script>
}


